{"version":3,"file":"index.js","sources":["../index.js"],"sourcesContent":["\n'use strict'\n\n// 日期的格式： 2019-11-11\nconst PATTERN_DATE = /^\\d{4}\\-\\d{2}\\-\\d{2}$/\n// 日期时间的格式：2019-11-11 11:11:11\nconst PATTERN_DATE_TIME = /^\\d{4}\\-\\d{2}\\-\\d{2} \\d{2}:\\d{2}:\\d{2}$/\n\n// 获取变量类型，返回小写格式\nfunction getType(value) {\n  return Object.prototype.toString.call(value).toLowerCase().slice(8, -1)\n}\n\nfunction extend(source, props) {\n  for (let key in props) {\n    source[key] = props[key]\n  }\n}\n\nexport function checkInteger(rule, value) {\n  if (getType(value) !== 'number' || value % 1 !== 0) {\n    return 'type'\n  }\n\n  if (rule.hasOwnProperty('min') && value < rule.min) {\n    return 'min'\n  }\n\n  if (rule.hasOwnProperty('max') && value > rule.max) {\n    return 'max'\n  }\n}\n\nexport function checkNumber(rule, value) {\n  if (getType(value) !== 'number' || isNaN(value)) {\n    return 'type'\n  }\n\n  if (rule.hasOwnProperty('min') && value < rule.min) {\n    return 'min'\n  }\n\n  if (rule.hasOwnProperty('max') && value > rule.max) {\n    return 'max'\n  }\n}\n\nexport function checkString(rule, value) {\n\n  if (getType(value) !== 'string') {\n    return 'type'\n  }\n\n  if (value === '') {\n    // 是否允许为空，默认不允许\n    if (rule.empty === true) {\n      return\n    }\n    else {\n      return 'empty'\n    }\n  }\n\n  if (rule.hasOwnProperty('min') && value.length < rule.min) {\n    return 'min'\n  }\n\n  if (rule.hasOwnProperty('max') && value.length > rule.max) {\n    return 'max'\n  }\n\n  if (rule.hasOwnProperty('pattern')\n    && !rule.pattern.test(value)\n  ) {\n    return 'pattern'\n  }\n\n}\n\nexport function checkBoolean(rule, value) {\n\n  if (getType(value) !== 'boolean') {\n    return 'type'\n  }\n\n  if (rule.hasOwnProperty('value')\n    && rule.value !== value\n  ) {\n    return 'value'\n  }\n\n}\n\nexport function checkEnum(rule, value) {\n  if (rule.values.indexOf(value) < 0) {\n    return 'type'\n  }\n}\n\nexport function checkArray(rule, value) {\n\n  if (!value || getType(value) !== 'array') {\n    return 'type'\n  }\n\n  const { length } = value\n\n  if (rule.hasOwnProperty('min') && length < rule.min) {\n    return 'min'\n  }\n\n  if (rule.hasOwnProperty('max') && length > rule.max) {\n    return 'max'\n  }\n\n  const { itemType } = rule\n  if (!itemType) {\n    return\n  }\n\n  for (let i = 0; i < length; i++) {\n    if (getType(value[ i ]) !== itemType) {\n      return 'itemType'\n    }\n  }\n\n}\n\nexport function checkObject(rule, value) {\n  if (!value || getType(value) !== 'object') {\n    return 'type'\n  }\n}\n\nexport function checkDate(rule, value) {\n\n  let props = {\n    type: 'string',\n    pattern: PATTERN_DATE,\n  }\n\n  let newRule = {}\n  extend(newRule, rule)\n  extend(newRule, props)\n\n  return checkString(newRule, value)\n\n}\n\nexport function checkDateTime(rule, value) {\n\n  let props = {\n    type: 'string',\n    pattern: PATTERN_DATE_TIME,\n  }\n\n  let newRule = {}\n  extend(newRule, rule)\n  extend(newRule, props)\n\n  return checkString(newRule, value)\n\n}\n\nexport class Validator {\n\n  constructor() {\n    this.rules = {\n      int: checkInteger,\n      integer: checkInteger,\n      number: checkNumber,\n      string: checkString,\n      bool: checkBoolean,\n      boolean: checkBoolean,\n      enum: checkEnum,\n      array: checkArray,\n      object: checkObject,\n      date: checkDate,\n      dateTime: checkDateTime,\n    }\n    this.messages = { }\n  }\n\n  add(name, handler, messages) {\n\n    if (getType(name) === 'object') {\n      extend(this.rules, name)\n      if (getType(handler) === 'object') {\n        extend(this.messages, handler)\n      }\n    }\n    else {\n      this.rules[ name ] = handler\n      this.messages[ name ] = messages\n    }\n\n  }\n\n  validate(data, rules, messages) {\n\n    const errors = { }\n\n    for (let key in rules) {\n\n      let rule = rules[ key ]\n\n      switch (getType(rule)) {\n        case 'string':\n          rule = {\n            type: rule,\n          }\n          break\n\n        case 'array':\n          rule = {\n            type: 'enum',\n            values: rule,\n          }\n          break\n\n        case 'regexp':\n          rule = {\n            type: 'string',\n            pattern: rule,\n          }\n          break\n      }\n\n      if (getType(rule) !== 'object' || !rule.type) {\n        throw new Error(`${key}'s rule is not found.`)\n      }\n\n      let errorReason\n\n      if (data.hasOwnProperty(key)) {\n        errorReason = this.rules[ rule.type ](rule, data[ key ], data)\n      }\n      else {\n        // 默认必传\n        if (rule.required !== false) {\n          errorReason = 'required'\n        }\n        else {\n          continue\n        }\n      }\n\n      if (errorReason) {\n\n        let message = messages && messages[ key ] && messages[ key ][ errorReason ]\n        if (getType(message) !== 'string') {\n          message = this.messages[ rule.type ] && this.messages[ rule.type ][ errorReason ]\n        }\n\n        errors[key] = getType(message) === 'string'\n          ? message\n          : errorReason\n\n      }\n\n    }\n\n    if (Object.keys(errors).length > 0) {\n      return errors\n    }\n\n  }\n\n}\n"],"names":["const","let"],"mappings":"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"}